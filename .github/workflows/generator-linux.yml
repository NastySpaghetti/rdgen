name: Custom Linux Client Generator
run-name: Custom Linux Client Generator
on: 
  workflow_dispatch:
    inputs:
      version:
        description: 'version to buld'
        required: true
        default: ''
        type: string
      zip_url:
        description: 'url to zip of json'
        required: true
        default: ''
        type: string

env:
  SCITER_RUST_VERSION: "1.75" # https://github.com/rustdesk/rustdesk/discussions/7503, also 1.78 has ABI change which causes our sciter version not working, https://blog.rust-lang.org/2024/03/30/i128-layout-update.html
  RUST_VERSION: "1.75" # sciter failed on m1 with 1.78 because of https://blog.rust-lang.org/2024/03/30/i128-layout-update.html
  CARGO_NDK_VERSION: "3.1.2"
  SCITER_ARMV7_CMAKE_VERSION: "3.29.7"
  SCITER_NASM_DEBVERSION: "2.14-1"
  LLVM_VERSION: "15.0.6"
  FLUTTER_VERSION: "3.24.5"
  ANDROID_FLUTTER_VERSION: "3.24.5" 
  FLUTTER_RUST_BRIDGE_VERSION: "1.80.1"
  # for arm64 linux because official Dart SDK does not work
  FLUTTER_ELINUX_VERSION: "3.16.9"
  TAG_NAME: "${{ inputs.upload-tag }}"
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
  # vcpkg version: 2024.07.12
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"
  ARMV7_VCPKG_COMMIT_ID: "6f29f12e82a8293156836ad81cc9bf5af41fe836"
  VERSION: "${{ inputs.version }}"
  NDK_VERSION: "r27c"
  #signing keys env variable checks
  ANDROID_SIGNING_KEY: "${{ secrets.ANDROID_SIGNING_KEY }}"
  MACOS_P12_BASE64: "${{ secrets.MACOS_P12_BASE64 }}"
  UPLOAD_ARTIFACT: 'true'
  SIGN_BASE_URL: "${{ secrets.SIGN_BASE_URL }}"
  STATUS_URL: "${{ secrets.GENURL }}/updategh"
  # RDGEN Auth Variables
  RDGEN_USER: "${{ secrets.RDGEN_USER }}"
  RDGEN_PASS: "${{ secrets.RDGEN_PASS }}"

jobs:
  generate-bridge-linux:
    uses: ./.github/workflows/bridge.yml
    with:
      version: ${{ inputs.version }}

  build-rustdesk-linux:
    needs: [generate-bridge-linux]
    name: build rustdesk linux ${{ matrix.job.target }}
    runs-on: ${{ matrix.job.on }}
    strategy:
      fail-fast: false
      matrix:
        # use a high level qemu-user-static
        job:
          - {
              arch: x86_64,
              target: x86_64-unknown-linux-gnu,
              distro: ubuntu18.04,
              on: ubuntu-22.04,
              deb_arch: amd64,
              vcpkg-triplet: x64-linux,
            }
          - {
            arch: aarch64,
            target: aarch64-unknown-linux-gnu,
            distro: ubuntu18.04,
            on: ubuntu-22.04-arm,
            deb_arch: arm64,
            vcpkg-triplet: arm64-linux,
          }
    steps:
      - name: install python deps
        run: |
          pip install requests pyzipper
      - name: Download, Decrypt, and Mask
        shell: python
        run: |
          import requests
          import pyzipper
          import io
          import os
          import json
          import time

          # Setup Basic Auth from env
          user = os.environ.get('RDGEN_USER')
          pwd = os.environ.get('RDGEN_PASS')
          auth_data = (user, pwd) if user and pwd else None

          # Safely parse the zip_url JSON
          try:
              zip_input = json.loads('${{ inputs.zip_url }}')
              base_url = zip_input.get('url', '')
              filename = zip_input.get('file', '')
          except Exception as e:
              print(f"Error parsing zip_url input: {e}")
              exit(1)

          for attempt in range(5):
            try:
              print(f"Downloading secrets (Attempt {attempt + 1})...")
              # Re-assembled URL using parsed JSON components
              r = requests.get(f"{base_url}/get_zip?filename={filename}", auth=auth_data, timeout=60)
              r.raise_for_status()
              break
            except (requests.exceptions.RequestException, requests.exceptions.Timeout) as e:
              if attempt < 4:
                print(f"Timeout/Error occurred: {e}. Retrying in 30 seconds...")
                time.sleep(30)
              else:
                print("Max retries reached. Failing.")
                raise e
          
          try:
            with pyzipper.AESZipFile(io.BytesIO(r.content)) as zf:
              zf.setpassword('${{ secrets.ZIP_PASSWORD }}'.encode())
              with zf.open('secrets.json') as f:
                secrets = json.load(f)
          except Exception as e:
            print(f"Error: Could not decrypt ZIP. Check if password matches. {e}")
            exit(1)

          with open(os.environ['GITHUB_ENV'], 'a') as env_file:
            for key, value in secrets.items():
              print(f"::add-mask::{value}")
              env_file.write(f"{key}={value}\n")
          
          print("Secrets loaded into environment.")

      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v6
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Set rdgen value
        if: ${{ env.rdgen == 'true' }}
        run: |
          echo "STATUS_URL=${{ secrets.GENURL }}/updategh" >> $GITHUB_ENV

      - name: Set rdgen value
        if: ${{ env.rdgen == 'false' }}
        run: |
          echo "STATUS_URL=${{ env.apiServer }}/api/updategh" >> $GITHUB_ENV

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "5% complete"}'
          username: ${{ env.RDGEN_USER }}
          password: ${{ env.RDGEN_PASS }}

      - name: Maximize build space
        run: |
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo apt-get update -y
          sudo apt-get install -y nasm
          if [[ "${{ matrix.job.arch }}" == "x86_64" ]]; then
            sudo apt-get install -y qemu-user-static
          fi
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Checkout source code
        if: ${{ env.VERSION != 'master' }}
        uses: actions/checkout@v4
        with:
          repository: rustdesk/rustdesk
          ref: refs/tags/${{ env.VERSION }}
          submodules: recursive

      - name: Checkout source code
        if: ${{ env.VERSION == 'master' }}
        uses: actions/checkout@v4
        with:
          repository: rustdesk/rustdesk
          submodules: recursive

      - name: Set Swap Space
        if: ${{ matrix.job.arch == 'x86_64' }}
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 12

      - name: Free Space
        run: |
          df -h
          free -m

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        if: matrix.job.arch == 'x86_64' || env.UPLOAD_ARTIFACT == 'true'
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.job.target }}
          components: "rustfmt"

      - name: Save Rust toolchain version
        run: |
          RUST_TOOLCHAIN_VERSION=$(cargo --version | awk '{print $2}')
          echo "RUST_TOOLCHAIN_VERSION=$RUST_TOOLCHAIN_VERSION" >> $GITHUB_ENV

      - name: Disable rust bridge build
        run: |
          # only build cdylib
          sed -i  "s/\[\"cdylib\", \"staticlib\", \"rlib\"\]/\[\"cdylib\"\]/g" Cargo.toml

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "15% complete"}'
          username: ${{ env.RDGEN_USER }}
          password: ${{ env.RDGEN_PASS }}

      - name: Restore bridge files
        if: matrix.job.arch == 'x86_64' || env.UPLOAD_ARTIFACT == 'true'
        uses: actions/download-artifact@master
        with:
          name: bridge-artifact
          path: ./

      - name: Setup vcpkg with Github Actions binary cache
        if: matrix.job.arch == 'x86_64' || env.UPLOAD_ARTIFACT == 'true'
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: /opt/artifacts/vcpkg
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}
          doNotCache: false

      - name: Install vcpkg dependencies
        if: matrix.job.arch == 'x86_64' || env.UPLOAD_ARTIFACT == 'true'
        run: |
          sudo apt install -y libva-dev && apt show libva-dev
          if ! $VCPKG_ROOT/vcpkg \
            install \
            --triplet ${{ matrix.job.vcpkg-triplet }} \
            --x-install-root="$VCPKG_ROOT/installed"; then
            find "${VCPKG_ROOT}/" -name "*.log" | while read -r _1; do
              echo "$_1:"
              echo "======"
              cat "$_1"
              echo "======"
              echo ""
            done
            exit 1
          fi
          head -n 100 "${VCPKG_ROOT}/buildtrees/ffmpeg/build-${{ matrix.job.vcpkg-triplet }}-rel-out.log" || true
        shell: bash

      - name: icon stuff
        if: ${{ env.iconlink_url != 'false' }}
        continue-on-error: true
        shell: bash
        run: |
          mv ./res/icon.ico ./res/icon.ico.bak
          mv ./res/icon.png ./res/icon.png.bak
          mv ./res/tray-icon.ico ./res/tray-icon.ico.bak
          # Using curl with auth instead of wget to match auth requirements
          curl -u "${{ env.RDGEN_USER }}:${{ env.RDGEN_PASS }}" -o ./res/icon.png "${{ env.iconlink_url }}/get_png?filename=${{ env.iconlink_file }}&uuid=${{ env.iconlink_uuid }}"
          mv ./res/32x32.png ./res/32x32.png.bak
          mv ./res/64x64.png ./res/64x64.png.bak
          mv ./res/128x128.png ./res/128x128.png.bak
          mv ./res/128x128@2x.png ./res/128x128@2x.png.bak
          convert ./res/icon.png -define icon:auto-resize=256,64,48,32,16 ./res/icon.ico
          convert ./res/icon.png -define icon:auto-resize=256,64,48,32,16 ./res/tray-icon.ico
          cp ./res/icon.ico ./res/tray-icon.ico
          convert ./res/icon.png -resize 32x32 ./res/32x32.png
          convert ./res/icon.png -resize 64x64 ./res/64x64.png
          convert ./res/icon.png -resize 128x128 ./res/128x128.png
          convert ./res/128x128.png -resize 200% ./res/128x128@2x.png
          cp ./src/ui.rs ./src/ui.rs.bak
          b64=$(base64 < ./res/icon.png)
          sed -i -e 's|iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHL[A-Za-z0-9+/=]+|'$(echo "$b64")'|' ./src/ui.rs
          b64=""

      - name: change appname to custom
        if: env.appname != 'rustdesk'
        continue-on-error: true
        shell: bash
        run: |
          sed -i -e 's|description = "RustDesk Remote Desktop"|description = "${{ env.appname }}"|' ./Cargo.toml
          sed -i -e 's|ProductName = "RustDesk"|ProductName = "${{ env.appname }}"|' ./Cargo.toml
          sed -i -e 's|FileDescription = "RustDesk Remote Desktop"|FileDescription = "${{ env.appname }}"|' ./Cargo.toml
          sed -i -e 's|OriginalFilename = "rustdesk.exe"|OriginalFilename = "${{ env.appname }}.exe"|' ./Cargo.toml
          sed -i -e 's|description = "RustDesk Remote Desktop"|description = "${{ env.appname }}"|' ./libs/portable/Cargo.toml
          sed -i -e 's|ProductName = "RustDesk"|ProductName = "${{ env.appname }}"|' ./libs/portable/Cargo.toml
          sed -i -e 's|FileDescription = "RustDesk Remote Desktop"|FileDescription = "${{ env.appname }}"|' ./libs/portable/Cargo.toml
          sed -i -e 's|OriginalFilename = "rustdesk.exe"|OriginalFilename = "${{ env.appname }}.exe"|' ./libs/portable/Cargo.toml
          sed -i -e 's|const APP_PREFIX: \&str = "rustdesk";|const APP_PREFIX: \&str = "${{ env.appname }}";|' ./libs/portable/src/main.rs
          find ./src/lang -name "*.rs" -exec sed -i -e 's|RustDesk|${{ env.appname }}|' {} \;
          sed -i -e '/-p tmpdeb\/usr\/lib\/rustdesk/d' ./build.py

      - name: change company name
        if: env.compname != 'Purslane Ltd'
        continue-on-error: true
        shell: bash
        run: |
          sed -i -e 's|Purslane Ltd|${{ env.compname }}|' ./flutter/lib/desktop/pages/desktop_setting_page.dart
          sed -i -e 's|Purslane Ltd|${{ env.compname }}|' ./Cargo.toml
          sed -i -e 's|Purslane Ltd|${{ env.compname }}|' ./libs/portable/Cargo.toml
          
      - name: allow custom.txt
        continue-on-error: true
        shell: bash
        run: |
          sed -i -e 's|rs-ny.rustdesk.com|${{ env.server }}|' ./libs/hbb_common/src/config.rs
          sed -i -e 's|OeVuKk5nlHiXp+APNn0Y3pC1Iwpwn44JGqrQCsWqmBw=|${{ env.key }}|' ./libs/hbb_common/src/config.rs
          wget https://raw.githubusercontent.com/bryangerlach/rdgen/refs/heads/master/.github/patches/allowCustom.py
          python allowCustom.py
          wget https://raw.githubusercontent.com/bryangerlach/rdgen/refs/heads/master/.github/patches/removeSetupServerTip.diff
          git apply removeSetupServerTip.diff
          echo -n "${{ env.custom }}" | cat > ./custom_.txt
          # sed -i '/intl:/a \ \ archive: ^3.6.1' ./flutter/pubspec.yaml
          sed -i -e 's|https://admin.rustdesk.com|${{ env.apiServer }}|' ./src/common.rs
          
      - name: change url to custom
        if: env.urlLink != 'https://rustdesk.com'
        continue-on-error: true
        shell: bash
        run: |  
          sed -i -e 's|Homepage: https://rustdesk.com|Homepage: ${{ env.urlLink }}|' ./build.py
          sed -i -e "s|launchUrl(Uri.parse('https://rustdesk.com'));|launchUrl(Uri.parse('${{ env.urlLink }}'));|" ./flutter/lib/common.dart
          sed -i -e "s|launchUrlString('https://rustdesk.com');|launchUrlString('${{ env.urlLink }}');|" ./flutter/lib/desktop/pages/desktop_setting_page.dart
          sed -i -e "s|launchUrlString('https://rustdesk.com/privacy.html')|launchUrlString('${{ env.urlLink }}/privacy.html')|" ./flutter/lib/desktop/pages/desktop_setting_page.dart
          sed -i -e "s|const url = 'https://rustdesk.com/';|const url = '${{ env.urlLink }}';|" ./flutter/lib/mobile/pages/settings_page.dart
          sed -i -e "s|launchUrlString('https://rustdesk.com/privacy.html')|launchUrlString('${{ env.urlLink }}/privacy.html')|" ./flutter/lib/mobile/pages/settings_page.dart
          sed -i -e "s|https://rustdesk.com/privacy.html|${{ env.urlLink }}/privacy.html|" ./flutter/lib/desktop/pages/install_page.dart

      - name: change download link to custom
        if: env.downloadLink != 'https://rustdesk.com/download'
        continue-on-error: true
        shell: bash
        run: |
          sed -i -e 's|https://rustdesk.com/download|${{ env.downloadLink }}|' ./flutter/lib/desktop/pages/desktop_home_page.dart
          sed -i -e 's|https://rustdesk.com/download|${{ env.downloadLink }}|' ./flutter/lib/mobile/pages/connection_page.dart
          sed -i -e 's|https://rustdesk.com/download|${{ env.downloadLink }}|' ./src/ui/index.tis

      - name: fix connection delay
        continue-on-error: true
        if: ${{ env.delayFix == 'true' }}
        shell: bash
        run: |
          sed -i -e 's|!key.is_empty()|false|' ./src/client.rs

      - name: add cycle monitors to toolbar
        continue-on-error: true
        if: env.cycleMonitor == 'true'
        run: |
          wget https://raw.githubusercontent.com/bryangerlach/rdgen/refs/heads/master/.github/patches/cycle_monitor.diff
          git apply cycle_monitor.diff

      - name: use X for offline display instead of orange circle
        continue-on-error: true
        if: env.xOffline == 'true'
        run: |
          wget https://raw.githubusercontent.com/bryangerlach/rdgen/refs/heads/master/.github/patches/xoffline.diff
          git apply xoffline.diff

      - name: hide-cm
        continue-on-error: true
        if: env.hidecm == 'true'
        run: |
          wget https://raw.githubusercontent.com/bryangerlach/rdgen/refs/heads/master/.github/patches/hidecm.diff
          git apply hidecm.diff
        
      - name: removeNewVersionNotif
        continue-on-error: true
        if: env.removeNewVersionNotif == 'true'
        run: | 
          sed -i -e 's|updateUrl.isNotEmpty|false|' ./flutter/lib/desktop/pages/desktop_home_page.dart
          sed -i '/let (request, url) =/,/Ok(())/{/Ok(())/!d}' ./src/common.rs

      - name: Restore bridge files
        if: matrix.job.arch == 'x86_64' || env.UPLOAD_ARTIFACT == 'true'
        uses: actions/download-artifact@master
        with:
          name: bridge-artifact
          path: ./

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "65% complete"}'
          username: ${{ env.RDGEN_USER }}
          password: ${{ env.RDGEN_PASS }}

      - uses: rustdesk-org/run-on-arch-action@amd64-support
        name: Build rustdesk
        id: vcpkg
        if: matrix.job.arch == 'x86_64' || env.UPLOAD_ARTIFACT == 'true'
        with:
          arch: ${{ matrix.job.arch }}
          distro: ${{ matrix.job.distro }}
          githubToken: ${{ github.token }}
          setup: |
            ls -l "${PWD}"
            ls -l /opt/artifacts/vcpkg/installed
          dockerRunArgs: |
            --volume "${PWD}:/workspace"
            --volume "/opt/artifacts:/opt/artifacts"
          shell: /bin/bash
          install: |
            apt-get update -y
            echo -e "installing deps"
            apt-get install -y \
               build-essential \
               clang \
               cmake \
               curl \
               gcc \
               git \
               g++ \
               imagemagick \
               libayatana-appindicator3-dev \
               libasound2-dev \
               libclang-10-dev \
               libgstreamer1.0-dev \
               libgstreamer-plugins-base1.0-dev \
               libgtk-3-dev \
               libpam0g-dev \
               libpulse-dev \
               libva-dev \
               libxcb-randr0-dev \
               libxcb-shape0-dev \
               libxcb-xfixes0-dev \
               libxdo-dev \
               libxfixes-dev \
               llvm-10-dev \
               nasm \
               ninja-build \
               pkg-config \
               tree \
               python3 \
               rpm \
               unzip \
               wget \
               xz-utils \
               libssl-dev
            # we have libopus compiled by us.
            apt-get remove -y libopus-dev || true
            # output devs
            ls -l ./
            tree -L 3 /opt/artifacts/vcpkg/installed
          run: |
            # disable git safe.directory
            git config --global --add safe.directory "*"
            # rust
            pushd /opt
            # do not use rustup, because memory overflow in qemu
            wget -O rust.tar.gz https://static.rust-lang.org/dist/rust-${{env.RUST_TOOLCHAIN_VERSION}}-${{ matrix.job.target }}.tar.gz
            tar -zxvf rust.tar.gz > /dev/null && rm rust.tar.gz
            cd rust-${{env.RUST_TOOLCHAIN_VERSION}}-${{ matrix.job.target }} && ./install.sh
            rm -rf rust-${{env.RUST_TOOLCHAIN_VERSION}}-${{ matrix.job.target }}
            # edit config
            mkdir -p ~/.cargo/
            echo """
              [source.crates-io]
              registry = 'https://github.com/rust-lang/crates.io-index'
            """ > ~/.cargo/config
            cat ~/.cargo/config
            # start build
            pushd /workspace
            export VCPKG_ROOT=/opt/artifacts/vcpkg
            if [[ "${{ matrix.job.arch }}" == "aarch64" ]]; then
              export JOBS="--jobs 3"
            else
              export JOBS=""
            fi
            echo $JOBS
            cargo build --lib $JOBS --features hwcodec,flutter,unix-file-copy-paste --release
            rm -rf target/release/deps target/release/build
            rm -rf ~/.cargo

            # Setup Flutter
            # disable git safe.directory
            git config --global --add safe.directory "*"
            pushd /workspace
            case ${{ matrix.job.arch }} in
              aarch64)
                export PATH=/opt/flutter-elinux/bin:$PATH
                sed -i "s/flutter build linux --release/flutter-elinux build linux --verbose/g" ./build.py
                sed -i "s/x64\/release/arm64\/release/g" ./build.py
              ;;
              x86_64)
                export PATH=/opt/flutter/bin:$PATH
              ;;
            esac
            popd
            pushd /opt
            wget https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${{ env.FLUTTER_VERSION }}-stable.tar.xz
            tar xf flutter_linux_${{ env.FLUTTER_VERSION }}-stable.tar.xz
            case ${{ matrix.job.arch }} in
              aarch64)
                # clone repo and reset to flutter ${{ env.FLUTTER_VERSION }}
                git clone https://github.com/sony/flutter-elinux.git || true
                pushd flutter-elinux
                  git fetch
                  git reset --hard ${{ env.FLUTTER_VERSION }}
                  bin/flutter-elinux doctor -v
                  bin/flutter-elinux precache --linux
                popd
                cp -R flutter/bin/cache/artifacts/engine/linux-x64/shader_lib flutter-elinux/flutter/bin/cache/artifacts/engine/linux-arm64
                rm -rf flutter
              ;;
              x86_64)
                flutter doctor -v
              ;;
            esac

            if [[ "3.24.5" == ${{ env.FLUTTER_VERSION }} ]]; then
              case ${{ matrix.job.arch }} in
                aarch64)
                  pushd /opt/flutter-elinux/flutter
                ;;
                x86_64)
                  pushd /opt/flutter
                ;;
              esac
              git apply ${{ github.workspace }}/.github/patches/flutter_3.24.4_dropdown_menu_enableFilter.diff
              popd
            fi

            # build flutter
            pushd /workspace
            mkdir output
            chmod 777 output -R
            export CARGO_INCREMENTAL=0
            export DEB_ARCH=${{ matrix.job.deb_arch }}
            mkdir -p flutter/tmpdeb/usr/share/rustdesk
            cp ./custom_.txt ./flutter/tmpdeb/usr/share/rustdesk/custom_.txt
            if [[ "${{ env.logolink_url }}" != "false" ]]; then
              curl -u "${{ env.RDGEN_USER }}:${{ env.RDGEN_PASS }}" -o ./flutter/assets/logo.png "${{ env.logolink_url }}/get_png?filename=${{ env.logolink_file }}&uuid=${{ env.logolink_uuid }}"
            fi
            if [[ "${{ env.iconlink_url }}" != "false" ]]; then
              mv ./flutter/assets/icon.svg ./flutter/assets/icon.svg.bak
              convert ./res/icon.png ./flutter/assets/icon.svg
              convert ./res/128x128.png -resize 200% ./flutter/assets/128x128@2x.png || true
              cp ./flutter/assets/icon.svg ./res/scalable.svg
              pushd ./flutter
              if [[ "${{ matrix.job.arch }}" == "aarch64" ]]; then
                export PATH="/opt/flutter-elinux/flutter/bin:$PATH"
              fi
              flutter pub get
              dart run flutter_launcher_icons
              popd
            fi
            python3 ./build.py --flutter --skip-cargo
            for name in rustdesk*??.deb; do
              mv "$name" /workspace/output/"${{ env.filename }}-${{ matrix.job.arch }}.deb"
            done

            # rpm package
            echo -e "start packaging fedora package"
            pushd /workspace
            case ${{ matrix.job.arch }} in
              aarch64)
                sed -i "s/linux\/x64/linux\/arm64/g" ./res/rpm-flutter.spec
                ;;
            esac
            HBB=`pwd` rpmbuild ./res/rpm-flutter.spec -bb
            pushd ~/rpmbuild/RPMS/${{ matrix.job.arch }}
            for name in rustdesk*??.rpm; do
                mv "$name" /workspace/output/"${{ env.filename }}-${{ matrix.job.arch }}.rpm"
            done

            # rpm suse package
            echo -e "start packaging suse package"
            pushd /workspace
            case ${{ matrix.job.arch }} in
              aarch64)
                sed -i "s/linux\/x64/linux\/arm64/g" ./res/rpm-flutter-suse.spec
                ;;
            esac
            HBB=`pwd` rpmbuild ./res/rpm-flutter-suse.spec -bb
            pushd ~/rpmbuild/RPMS/${{ matrix.job.arch }}
            for name in rustdesk*??.rpm; do
                mv "$name" /workspace/output/"${{ env.filename }}-suse-${{ matrix.job.arch }}.rpm"
            done

      # only x86_64 for arch since we can not find newest arm64 docker image to build
      # old arch image does not make sense for arch since it is "arch" which always update to date
      # and failed to makepkg arm64 on x86_64
      - name: Patch archlinux PKGBUILD
        continue-on-error: true
        if: matrix.job.arch == 'x86_64' && env.UPLOAD_ARTIFACT == 'true' && env.VERSION != 'master'
        run: |
          sed -i "s/x86_64/${{ matrix.job.arch }}/g" res/PKGBUILD
          if [[ "${{ matrix.job.arch }}" == "aarch64" ]]; then
            sed -i "s/x86_64/aarch64/g" ./res/PKGBUILD
          fi

      - name: Build archlinux package
        continue-on-error: true
        if: matrix.job.arch == 'x86_64' && env.UPLOAD_ARTIFACT == 'true' && env.VERSION != 'master'
        uses: rustdesk-org/arch-makepkg-action@master
        with:
          packages:
          scripts: |
            cd res && HBB=`pwd`/.. FLUTTER=1 makepkg -f

      - name: Rename archlinux package
        continue-on-error: true
        if:  matrix.job.arch == 'x86_64' && env.UPLOAD_ARTIFACT == 'true' && env.VERSION != 'master'
        run: |
          cp ./res/rustdesk-${{ env.VERSION }}-0-x86_64.pkg.tar.zst ./output/${{ env.filename }}-${{ matrix.job.arch }}.pkg.tar.zst

      - name: send file to rdgen server
        if: ${{ env.rdgen == 'true' }}
        shell: bash
        run: |
          curl -i -X POST -u "${{ env.RDGEN_USER }}:${{ env.RDGEN_PASS }}" -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./output/${{ env.filename }}-${{ matrix.job.arch }}.deb" -F "uuid=${{ env.uuid }}" ${{ secrets.GENURL }}/save_custom_client
          curl -i -X POST -u "${{ env.RDGEN_USER }}:${{ env.RDGEN_PASS }}" -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./output/${{ env.filename }}-${{ matrix.job.arch }}.rpm" -F "uuid=${{ env.uuid }}" ${{ secrets.GENURL }}/save_custom_client
          curl -i -X POST -u "${{ env.RDGEN_USER }}:${{ env.RDGEN_PASS }}" -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./output/${{ env.filename }}-suse-${{ matrix.job.arch }}.rpm" -F "uuid=${{ env.uuid }}" ${{ secrets.GENURL }}/save_custom_client
          curl -i -X POST -u "${{ env.RDGEN_USER }}:${{ env.RDGEN_PASS }}" -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./output/${{ env.filename }}-${{ matrix.job.arch }}.pkg.tar.zst" -F "uuid=${{ env.uuid }}" ${{ secrets.GENURL }}/save_custom_client || true

      - name: send file to api server
        if: ${{ env.rdgen == 'false' }}
        shell: bash
        run: |
          curl -i -X POST -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./output/${{ env.filename }}-${{ matrix.job.arch }}.deb" ${{ env.apiServer }}/api/save_custom_client
          curl -i -X POST -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./output/${{ env.filename }}-${{ matrix.job.arch }}.rpm" ${{ env.apiServer }}/api/save_custom_client
          curl -i -X POST -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./output/${{ env.filename }}-suse-${{ matrix.job.arch }}.rpm" ${{ env.apiServer }}/api/save_custom_client
          curl -i -X POST -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./output/${{ env.filename }}-${{ matrix.job.arch }}.pkg.tar.zst" ${{ env.apiServer }}/api/save_custom_client || true

      - name: Upload deb
        uses: actions/upload-artifact@master
        if: env.UPLOAD_ARTIFACT == 'true'
        with:
          name: ${{ env.filename }}-${{ matrix.job.arch }}.deb
          path: ./output/${{ env.filename }}-${{ matrix.job.arch }}.deb

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "Finished ${{ matrix.job.arch }}"}'
          username: ${{ env.RDGEN_USER }}
          password: ${{ env.RDGEN_PASS }}

      - name: failed
        if: failure()
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "Generation failed, try again"}'
          username: ${{ env.RDGEN_USER }}
          password: ${{ env.RDGEN_PASS }}

      - name: failed
        if: cancelled()
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "Generation cancelled, try again"}'
          username: ${{ env.RDGEN_USER }}
          password: ${{ env.RDGEN_PASS }}

  build-appimage:
    name: Build appimage ${{ matrix.job.target }}
    needs: [build-rustdesk-linux]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        job:
          - { target: x86_64-unknown-linux-gnu, arch: x86_64 }
          - { target: aarch64-unknown-linux-gnu, arch: aarch64 }
    steps:
      - name: install python deps
        run: |
          pip install requests pyzipper
      - name: Download, Decrypt, and Mask
        shell: python
        run: |
          import requests
          import pyzipper
          import io
          import os
          import json
          import time

          user = os.environ.get('RDGEN_USER')
          pwd = os.environ.get('RDGEN_PASS')
          auth_data = (user, pwd) if user and pwd else None

          try:
              zip_input = json.loads('${{ inputs.zip_url }}')
              base_url = zip_input.get('url', '')
              filename = zip_input.get('file', '')
          except Exception as e:
              print(f"Error parsing zip_url input: {e}")
              exit(1)

          for attempt in range(5):
            try:
              print(f"Downloading secrets (Attempt {attempt + 1})...")
              r = requests.get(f"{base_url}/get_zip?filename={filename}", auth=auth_data, timeout=60)
              r.raise_for_status()
              break
            except (requests.exceptions.RequestException, requests.exceptions.Timeout) as e:
              if attempt < 4:
                print(f"Timeout/Error occurred: {e}. Retrying in 30 seconds...")
                time.sleep(30)
              else:
                print("Max retries reached. Failing.")
                raise e
          
          try:
            with pyzipper.AESZipFile(io.BytesIO(r.content)) as zf:
              zf.setpassword('${{ secrets.ZIP_PASSWORD }}'.encode())
              with zf.open('secrets.json') as f:
                secrets = json.load(f)
          except Exception as e:
            print(f"Error: Could not decrypt ZIP. Check if password matches. {e}")
            exit(1)

          with open(os.environ['GITHUB_ENV'], 'a') as env_file:
            for key, value in secrets.items():
              print(f"::add-mask::{value}")
              env_file.write(f"{key}={value}\n")
          
          print("Secrets loaded into environment.")

      - name: Checkout source code
        if: ${{ env.VERSION != 'master' }}
        uses: actions/checkout@v4
        with:
          repository: rustdesk/rustdesk
          ref: refs/tags/${{ env.VERSION }}
          submodules: recursive

      - name: Checkout source code
        if: ${{ env.VERSION == 'master' }}
        uses: actions/checkout@v4
        with:
          repository: rustdesk/rustdesk
          submodules: recursive

      - name: Download Binary
        uses: actions/download-artifact@master
        with:
          name: ${{ env.filename }}-${{ matrix.job.arch }}.deb
          path: .

      - name: Rename Binary
        run: |
          mv ${{ env.filename }}-${{ matrix.job.arch }}.deb appimage/rustdesk.deb

      - name: Build appimage package
        shell: bash
        run: |
          # install libarchive-tools for bsdtar command used in AppImageBuilder.yml
          sudo apt-get update -y
          sudo apt-get install -y libarchive-tools libfuse2
          # set-up appimage-builder
          sudo pip3 install git+https://github.com/rustdesk-org/appimage-builder.git
          # run appimage-builder
          pushd appimage
          sudo appimage-builder --skip-tests --recipe ./AppImageBuilder-${{ matrix.job.arch }}.yml
          sudo mv ./rustdesk-${{ env.VERSION }}-${{ matrix.job.arch }}.AppImage ./${{ env.filename }}-${{ matrix.job.arch }}.AppImage

      - name: send file to rdgen server
        if: ${{ env.rdgen == 'true' }}
        shell: bash
        run: |
          curl -i -X POST -u "${{ env.RDGEN_USER }}:${{ env.RDGEN_PASS }}" -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./appimage/${{ env.filename }}-${{ matrix.job.arch }}.AppImage" -F "uuid=${{ env.uuid }}" ${{ secrets.GENURL }}/save_custom_client
          
      - name: send file to api server
        if: ${{ env.rdgen == 'false' }}
        shell: bash
        run: |
          curl -i -X POST -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./appimage/${{ env.filename }}-${{ matrix.job.arch }}.AppImage" ${{ env.apiServer }}/api/save_custom_client

  build-flatpak:
    name: Build flatpak ${{ matrix.job.target }}${{ matrix.job.suffix }}
    needs:
      - build-rustdesk-linux
    runs-on: ${{ matrix.job.on }}
    strategy:
      fail-fast: false
      matrix:
        job:
          - {
              target: x86_64-unknown-linux-gnu,
              distro: ubuntu18.04,
              on: ubuntu-22.04,
              arch: x86_64,
              suffix: "",
            }
          - {
              target: aarch64-unknown-linux-gnu,
              # try out newer flatpak since error of "error: Nothing matches org.freedesktop.Platform in remote flathub"
              distro: ubuntu22.04,
              on: ubuntu-22.04-arm,
              arch: aarch64,
              suffix: "",
            }
    steps:
      - name: install python deps
        run: |
          pip install requests pyzipper
      - name: Download, Decrypt, and Mask
        shell: python
        run: |
          import requests
          import pyzipper
          import io
          import os
          import json
          import time

          user = os.environ.get('RDGEN_USER')
          pwd = os.environ.get('RDGEN_PASS')
          auth_data = (user, pwd) if user and pwd else None

          try:
              zip_input = json.loads('${{ inputs.zip_url }}')
              base_url = zip_input.get('url', '')
              filename = zip_input.get('file', '')
          except Exception as e:
              print(f"Error parsing zip_url input: {e}")
              exit(1)

          for attempt in range(5):
            try:
              print(f"Downloading secrets (Attempt {attempt + 1})...")
              r = requests.get(f"{base_url}/get_zip?filename={filename}", auth=auth_data, timeout=60)
              r.raise_for_status()
              break
            except (requests.exceptions.RequestException, requests.exceptions.Timeout) as e:
              if attempt < 4:
                print(f"Timeout/Error occurred: {e}. Retrying in 30 seconds...")
                time.sleep(30)
              else:
                print("Max retries reached. Failing.")
                raise e
          
          try:
            with pyzipper.AESZipFile(io.BytesIO(r.content)) as zf:
              zf.setpassword('${{ secrets.ZIP_PASSWORD }}'.encode())
              with zf.open('secrets.json') as f:
                secrets = json.load(f)
          except Exception as e:
            print(f"Error: Could not decrypt ZIP. Check if password matches. {e}")
            exit(1)

          with open(os.environ['GITHUB_ENV'], 'a') as env_file:
            for key, value in secrets.items():
              print(f"::add-mask::{value}")
              env_file.write(f"{key}={value}\n")
          
          print("Secrets loaded into environment.")

      - name: Checkout source code
        if: ${{ env.VERSION != 'master' }}
        uses: actions/checkout@v4
        with:
          repository: rustdesk/rustdesk
          ref: refs/tags/${{ env.VERSION }}
          submodules: recursive

      - name: Checkout source code
        if: ${{ env.VERSION == 'master' }}
        uses: actions/checkout@v4
        with:
          repository: rustdesk/rustdesk
          submodules: recursive

      - name: Download Binary
        uses: actions/download-artifact@master
        with:
          name: ${{ env.filename }}-${{ matrix.job.arch }}.deb
          path: .

      - name: Rename Binary
        run: |
          mv ${{ env.filename }}-${{ matrix.job.arch }}.deb flatpak/rustdesk.deb

      - uses: rustdesk-org/run-on-arch-action@amd64-support
        name: Build rustdesk flatpak package for ${{ matrix.job.arch }}
        continue-on-error: true
        timeout-minutes: 30
        id: flatpak
        with:
          arch: ${{ matrix.job.arch }}
          distro: ${{ matrix.job.distro }}
          githubToken: ${{ github.token }}
          setup: |
            ls -l "${PWD}"
          dockerRunArgs: |
            --volume "${PWD}:/workspace"
          shell: /bin/bash
          install: |
            apt-get update -y
            apt-get install -y git flatpak flatpak-builder
          run: |
            # disable git safe.directory
            git config --global --add safe.directory "*"
            pushd /workspace
            # flatpak deps
            flatpak --user remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
            # package
            pushd flatpak
            git clone https://github.com/flathub/shared-modules.git --depth=1
            flatpak-builder --user --install-deps-from=flathub -y --force-clean --repo=repo ./build ./rustdesk.json
            flatpak build-bundle ./repo ${{ env.filename }}-${{ matrix.job.arch }}.flatpak com.rustdesk.RustDesk

      - name: send file to rdgen server
        if: ${{ env.rdgen == 'true' }}
        continue-on-error: true
        shell: bash
        run: |
          curl -i -X POST -u "${{ env.RDGEN_USER }}:${{ env.RDGEN_PASS }}" -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./flatpak/${{ env.filename }}-${{ matrix.job.arch }}.flatpak" -F "uuid=${{ env.uuid }}" ${{ secrets.GENURL }}/save_custom_client
          
      - name: send file to api server
        if: ${{ env.rdgen == 'false' }}
        continue-on-error: true
        shell: bash
        run: |
          curl -i -X POST -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./flatpak/${{ env.filename }}-${{ matrix.job.arch }}.flatpak" ${{ env.apiServer }}/api/save_custom_client



  deploy:
    needs: [build-rustdesk-linux,build-flatpak,build-appimage]
    runs-on: ubuntu-latest
    steps:
      - name: install python deps
        run: |
          pip install requests pyzipper
      - name: Download, Decrypt, and Mask
        shell: python
        run: |
          import requests
          import pyzipper
          import io
          import os
          import json
          import time

          user = os.environ.get('RDGEN_USER')
          pwd = os.environ.get('RDGEN_PASS')
          auth_data = (user, pwd) if user and pwd else None

          try:
              zip_input = json.loads('${{ inputs.zip_url }}')
              base_url = zip_input.get('url', '')
              filename = zip_input.get('file', '')
          except Exception as e:
              print(f"Error parsing zip_url input: {e}")
              exit(1)

          for attempt in range(5):
            try:
              print(f"Downloading secrets (Attempt {attempt + 1})...")
              r = requests.get(f"{base_url}/get_zip?filename={filename}", auth=auth_data, timeout=60)
              r.raise_for_status()
              break
            except (requests.exceptions.RequestException, requests.exceptions.Timeout) as e:
              if attempt < 4:
                print(f"Timeout/Error occurred: {e}. Retrying in 30 seconds...")
                time.sleep(30)
              else:
                print("Max retries reached. Failing.")
                raise e
          
          try:
            with pyzipper.AESZipFile(io.BytesIO(r.content)) as zf:
              zf.setpassword('${{ secrets.ZIP_PASSWORD }}'.encode())
              with zf.open('secrets.json') as f:
                secrets = json.load(f)
          except Exception as e:
            print(f"Error: Could not decrypt ZIP. Check if password matches. {e}")
            exit(1)

          with open(os.environ['GITHUB_ENV'], 'a') as env_file:
            for key, value in secrets.items():
              print(f"::add-mask::{value}")
              env_file.write(f"{key}={value}\n")
          
          print("Secrets loaded into environment.")

      - name: Finalize and Cleanup zip/json
        if: always() # Run even if previous steps fail
        continue-on-error: true
        uses: fjogeleit/http-request-action@v1
        with:
          url: "${{ secrets.GENURL }}/cleanzip"
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}"}'
          username: ${{ env.RDGEN_USER }}
          password: ${{ env.RDGEN_PASS }}

      - name: Set rdgen value
        if: ${{ env.rdgen == 'true' }}
        run: |
          echo "STATUS_URL=${{ secrets.GENURL }}/updategh" >> $GITHUB_ENV

      - name: Set rdgen value
        if: ${{ env.rdgen == 'false' }}
        run: |
          echo "STATUS_URL=${{ env.apiServer }}/api/updategh" >> $GITHUB_ENV
          
      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "Success"}'
          username: ${{ env.RDGEN_USER }}
          password: ${{ env.RDGEN_PASS }}

      - uses: geekyeggo/delete-artifact@v5
        continue-on-error: true
        with:
            name: ${{ env.filename }}-*.deb
